module.exports=function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=21)}([function(t,e){t.exports=flarum.core.compat["common/app"]},function(t,e){t.exports=flarum.core.compat["common/extend"]},,function(t,e){t.exports=flarum.core.compat["common/helpers/icon"]},function(t,e){t.exports=flarum.core.compat["common/components/Button"]},function(t,e){t.exports=flarum.core.compat["common/components/Page"]},function(t,e){t.exports=flarum.core.compat["common/components/TextEditor"]},function(t,e){t.exports=flarum.core.compat["common/components/DiscussionPage"]},function(t,e){t.exports=flarum.core.compat["common/components/CommentPost"]},function(t,e){t.exports=flarum.core.compat["common/Fragment"]},function(t,e){t.exports=flarum.core.compat["utils/DiscussionControls"]},function(t,e){t.exports=flarum.core.compat["components/EditPostComposer"]},function(t,e){t.exports=flarum.core.compat["components/TextEditor"]},function(t,e){t.exports=flarum.core.compat["common/Component"]},function(t,e){t.exports=flarum.core.compat["common/components/Dropdown"]},function(t,e){t.exports=flarum.core.compat["common/utils/ItemList"]},function(t,e){t.exports=flarum.core.compat["common/components/DiscussionComposer"]},function(t,e){t.exports=flarum.core.compat["common/components/EditPostComposer"]},function(t,e){t.exports=flarum.core.compat["common/components/ReplyComposer"]},,,function(t,e,n){"use strict";n.r(e);var o=n(1),r=n(0),i=n.n(r),a=n(5),c=n.n(a),s=n(6),l=n.n(s),u=n(7),p=n.n(u);function f(t){return{inline:[t.inline.left,t.inline.right],display:[t.block.left,t.block.right]}}var d=function(t,e){for(var n=t.querySelectorAll(".katex-mathml + .katex-html"),o=0;o<n.length;o++){var r=n[o];r.remove?r.remove(null):r.parentNode.removeChild(r)}for(var i=t.querySelectorAll(".katex-mathml"),a=0;a<i.length;a++){var c=i[a],s=c.querySelector("annotation");s&&(c.replaceWith?c.replaceWith(s):c.parentNode.replaceChild(s,c),s.innerHTML=e.inline[0]+s.innerHTML+e.inline[1])}for(var l=t.querySelectorAll(".katex-display annotation"),u=0;u<l.length;u++){var m=l[u];m.innerHTML=e.display[0]+m.innerHTML.substr(e.inline[0].length,m.innerHTML.length-e.inline[0].length-e.inline[1].length)+e.display[1]}return t};function h(t,e){return void 0===e&&(e=!1),t.attribute("mathren.aliases_as_primary")&&!1===e?{inline:t.attribute("mathren.primary_inline_delimiter_alias"),block:t.attribute("mathren.primary_block_delimiter_alias")}:{inline:t.attribute("mathren.primary_inline_delimiter"),block:t.attribute("mathren.primary_block_delimiter")}}var v=n(8),b=n.n(v);function y(t,e){return(y=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function x(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,y(t,e)}var g=n(9),_=n.n(g),w=n(3),C=n.n(w),k=n(10),T=n.n(k),S=n(11),j=n.n(S);function E(t,e,n){var o=t.user(),r='@"'+(o&&function(t){return t.displayName().replace(/"#[a-z]{0,3}[0-9]+/,"_")}(o)||app.translator.trans("core.lib.username.deleted_text"))+'"#p'+t.id()+" ";e.fields.content()||(e.body.attrs.originalContent=r);var i=e.editor.getSelectionRange()[0],a=e.fields.content().slice(0,i),c=0==a.length?0:3-a.match(/(\n{0,2})$/)[0].length;e.editor.insertAtCursor(Array(c).join("\n")+(n?"> "+r+n.trim().replace(/\n/g,"\n> ")+"\n\n":r),!1)}var O=function(t){function e(e){var n;return(n=t.call(this)||this).post=e,n}x(e,t);var n=e.prototype;return n.view=function(){var t=this;return m("button",{class:"Button PostQuoteButton",onclick:function(){return e=t.post,n=t.content,void(app.composer.bodyMatches(j.a)&&app.composer.body.attrs.post.discussion()===e.discussion()?E(e,app.composer,n):T.a.replyAction.call(e.discussion()).then((function(t){return E(e,t,n)})));var e,n}},C()("fas fa-quote-left",{className:"Button-icon"}),app.translator.trans("flarum-mentions.forum.post.quote_button"))},n.show=function(t,e){var n=this.$().show(),o=n.offsetParent().offset();n.css("left",t-o.left).css("top",e-o.top),this.hideHandler=this.hide.bind(this),$(document).on("mouseup",this.hideHandler)},n.showStart=function(t,e){var n=this.$();this.show(t,$(window).scrollTop()+e-n.outerHeight()-5)},n.showEnd=function(t,e){var n=this.$();this.show(t-n.outerWidth(),$(window).scrollTop()+e+5)},n.hide=function(){this.$().hide(),$(document).off("mouseup",this.hideHandler)},e}(_.a);function D(){Object(o.extend)(b.a.prototype,"oncreate",(function(){if("flarum-mentions"in flarum.extensions&&app.forum.attribute("mathren.enable_copy_tex")){var t=this.attrs.post,e=app.session.user,n=h.bind(this,app.forum)();if(!(t.isHidden()||e&&!t.discussion().canReply())){var o=this.$(".Post-body"),r=$('<div class="MathRen-quoteButtonContainer"></div>'),i=new O(t),a=function(t){setTimeout((function(){var e=function(t,e){var n=window.getSelection();if(n.rangeCount){var o=n.getRangeAt(0).commonAncestorContainer;if(t[0]===o||$.contains(t[0],o)){var r=n.getRangeAt(0).cloneContents();r.querySelector(".katex-mathml")&&(r=d(r,e));var i=$("<div>").append(r);return i.find("img.emoji").replaceWith((function(){return this.alt})),i.find("img").replaceWith((function(){return"![]("+this.src+")"})),i.find("a").replaceWith((function(){return"["+this.innerText+"]("+this.href+")"})),i.text()}}return""}(o,f(n));if(e){i.content=e,m.render(r[0],i.render());var a=window.getSelection().getRangeAt(0).getClientRects(),c=a[0];if(t.clientY<c.bottom&&t.clientX-c.right<c.left-t.clientX)i.showStart(c.left,c.top);else{var s=a[a.length-1];i.showEnd(s.right,s.bottom)}}}),1)};this.$().after(r).on("mouseup",a),"ontouchstart"in window&&document.addEventListener("selectionchange",a,!1)}}}))}var A=n(12),M=n.n(A),P=n(4),q=n.n(P),H=n(13),B=n.n(H),L=n(14),N=n.n(L),R=n(15),W=n.n(R),I=n(16),F=n.n(I),z=n(17),X=n.n(z),Q=n(18),Y=n.n(Q);function G(){return[F.a,X.a,Y.a]}var J=function(t){function e(){return t.apply(this,arguments)||this}x(e,t);var n=e.prototype;return n.view=function(){return N.a.component({className:"MathRen-buttonsDropdown",buttonClassName:"Button Button--flat",label:C()("fas fa-square-root-alt")},this.items().toArray())},n.items=function(){var t=this,e=new W.a;return e.add("mathren-blockButton",q.a.component({icon:"fas fa-vector-square",onclick:function(){return t.wrapSelection(!0)}},i.a.translator.trans("the-turk-mathren.forum.composer.block_expression")),50),e.add("mathren-inlineButton",q.a.component({icon:"fas fa-grip-lines",onclick:function(){return t.wrapSelection()}},i.a.translator.trans("the-turk-mathren.forum.composer.inline_expression")),0),e},n.wrapSelection=function(t){void 0===t&&(t=!1);var e=i.a.composer.body.componentClass;this.delimiters=h.bind(this,i.a.forum,-1===G().indexOf(e))();var n=t?this.delimiters.block.left:this.delimiters.inline.left,o=t?this.delimiters.block.right:this.delimiters.inline.right,r=this.attrs.textEditor.getSelectionRange();r[0]!=r[1]?(this.attrs.textEditor.insertAt(r[0],n),this.attrs.textEditor.insertAt(r[1]+n.length,o)):(this.attrs.textEditor.replaceBeforeCursor(r[0],n+o),this.attrs.textEditor.moveCursorTo(r[0]+n.length))},e}(B.a);var K=function(t,e,n){for(var o=n,r=0,i=t.length;o<e.length;){var a=e[o];if(r<=0&&e.slice(o,o+i)===t)return o;"\\"===a?o++:"{"===a?r++:"}"===a&&r--,o++}return-1},U=/^\\begin{/,V=function(t,e){for(var n,o=[],r=new RegExp("("+e.map((function(t){return t.left.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")})).join("|")+")");-1!==(n=t.search(r));){n>0&&(o.push({type:"text",data:t.slice(0,n)}),t=t.slice(n));var i=e.findIndex((function(e){return t.startsWith(e.left)}));if(-1===(n=K(e[i].right,t,e[i].left.length)))break;var a=t.slice(0,n+e[i].right.length),c=U.test(a)?a:t.slice(e[i].left.length,n);o.push({type:"math",data:c,rawData:a,display:e[i].display}),t=t.slice(n+e[i].right.length)}return""!==t&&o.push({type:"text",data:t}),o},Z=function(t,e){var n=V(t,e.splitAtDelimiters);if(1===n.length&&"text"===n[0].type)return null;for(var o=document.createDocumentFragment(),r=0;r<n.length;r++)if("text"===n[r].type)o.appendChild(document.createTextNode(n[r].data));else{var i=document.createElement("span"),a=n[r].data,c=!0===n[r].display?e.primaryBlockDelimiter:e.primaryInlineDelimiter;i.textContent=c.left+a+c.right,o.appendChild(i)}return o},tt=function t(e,n,o){for(var r=0;r<e.childNodes.length;r++){var i=e.childNodes[r];if(3===i.nodeType){var a=Z(i.textContent,n);a&&(r+=a.childNodes.length-1,e.replaceChild(a,i))}else 1===i.nodeType&&t(i,n)}return!0===o?e.innerText:e};i.a.initializers.add("the-turk-mathren",(function(){var t=function(t,e,o){void 0===t&&(t=""),void 0===e&&(e=!1),void 0===o&&(o=!0);var r=document.createElement("span");return r.innerHTML=t,tt(r,n(e),o)},e=function(e){i.a.forum.attribute("mathren.aliases_as_primary")&&e.querySelectorAll("code").forEach((function(e){return e.innerHTML=t(e.innerText,!0)}))},n=function(t){void 0===t&&(t=!1);var e=h.bind(void 0,i.a.forum,!t)(),n=i.a.forum.attribute("mathren.bbcode_delimiters"),o=i.a.forum.attribute("mathren.alias_delimiters"),r=t?n:o;return{primaryBlockDelimiter:e.block,primaryInlineDelimiter:e.inline,splitAtDelimiters:r}};D(),Object(o.extend)(M.a.prototype,"toolbarItems",(function(t){!0===app.forum.attribute("mathren.enable_editor_buttons")&&t.add("the-turk-mathren",m(J,{textEditor:this.attrs.composer.editor}))})),Object(o.extend)(p.a.prototype,"oncreate",(function(){if(app.forum.attribute("mathren.enable_copy_tex")){var t=h.bind(this,app.forum)();document.addEventListener("copy",(function(e){var n=window.getSelection();if(!n.isCollapsed){var o=n.getRangeAt(0).cloneContents();if(o.querySelector(".katex-mathml")){for(var r=[],i=0;i<o.childNodes.length;i++)r.push(o.childNodes[i].outerHTML);e.clipboardData.setData("text/html",r.join("")),e.clipboardData.setData("text/plain",d(o,f(t)).textContent),e.preventDefault()}}}))}})),Object(o.extend)(c.a.prototype,["oncreate","onupdate"],(function(){return e(document)})),s9e&&s9e.TextFormatter&&Object(o.override)(s9e.TextFormatter,"preview",(function(n,o,r){n(t(o),r),e(r)})),G().forEach((function(e){Object(o.override)(e.prototype,"onsubmit",(function(e){this.composer.fields.content(t(this.composer.fields.content())),e()}))})),Object(o.extend)(l.a.prototype,"oncreate",(function(e,n){var o=n.dom.querySelector("textarea"),r=i.a.composer.body.componentClass;if(-1===G().indexOf(r))o.addEventListener("input",(function(){o.value=t(o.value)}));else{if(!i.a.forum.attribute("mathren.aliases_as_primary"))return;o.value=t(this.value,!0)}}))}),-500)}]);
//# sourceMappingURL=forum.js.map